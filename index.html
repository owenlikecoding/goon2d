<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>Goonerbait 3D Adventure</title>
  <style>
    body {
      margin: 0;
      overflow: hidden;
      text-align: center;
    }

    canvas {
      background: #89cff0;
      display: block;
      margin: 0 auto;
    }

    #restartBtn {
      display: none;
      margin-top: 20px;
      padding: 10px 20px;
      font-size: 16px;
    }

    #dialogBox {
      position: absolute;
      top: 20%;
      left: 50%;
      transform: translateX(-50%);
      width: 400px;
      padding: 20px;
      background: rgba(0, 0, 0, 0.7);
      color: #fff;
      font-family: sans-serif;
      display: none;
    }
  </style>
</head>

<body>
  <canvas id="gamecanvs"></canvas>
  <button id="restartBtn">Restart</button>
  <div id="dialogBox"></div>
  <script>
    const canvas = document.getElementById("gamecanvs");
    const ctx = canvas.getContext("2d");
    canvas.width = 800;
    canvas.height = 600;

    // Game States: 'start', 'world', 'talk', 'combat', 'bossFight', 'win', 'over'
    let gameState = "start";

    // World & Story Variables
    const countries = [
      {
        name: "Old Kingdom",
        goonDensity: 1,
        npcs: [
          {
            x: 300,
            y: 400,
            type: "talk",
            dialog:
              "The ghost of the goon haunts these lands. Follow the river north.",
          },
          {
            x: 600,
            y: 200,
            type: "shop",
            dialog: "Buy a gun for 5 coins? Press E to buy.",
            cost: 5,
          },
        ],
      },
      {
        name: "Desert Realm",
        goonDensity: 2,
        npcs: [
          {
            x: 200,
            y: 300,
            type: "talk",
            dialog:
              "In the heat of the desert, the ghost roams. Seek the oasis.",
          },
        ],
      },
      {
        name: "Frozen Tundra",
        goonDensity: 3,
        npcs: [
          {
            x: 500,
            y: 350,
            type: "talk",
            dialog:
              "The cold hides many secrets. The ghost is near the ice cave.",
          },
        ],
      },
      // ... add more countries as desired
    ];
    let currentCountry = 0;
    let countryNameDisplayTime = 0; // when >0, display cool title animation
    const COUNTRY_NAME_DISPLAY_DURATION = 3000; // 3 seconds

    // Currency & Equipment
    let score = 0; // coins
    const player = {
      x: 100,
      y: 300,
      width: 30,
      height: 30,
      speed: 4,
      color: "red",
      weapon: "sword", // Always have a sword
      hasGun: false,
    };

    // World boundaries
    const worldBounds = { x: 0, y: 0, width: 1600, height: 1200 };
    // We'll simulate a camera following the player
    let camera = { x: 0, y: 0 };

    // Goons spawn (ambient enemies)
    const goons = [];
    let goonTimer = 0;
    const baseGoonInterval = 2000; // ms, modified by country's goonDensity

    // Missing declarations added:
    const coins = [];
    let coinTimer = 0;

    // NPCs currently in the world (from current country)
    let activeNPCs = [];
    // Dialog management
    const dialogBox = document.getElementById("dialogBox");
    let currentDialog = "";
    let dialogActive = false;

    // Bullets for combat (bossFight and active combat)
    const bullets = [];
    const bulletSpeed = 6;

    // Final Boss (will appear in bossFight state)
    const boss = {
      x: worldBounds.width - 150,
      y: 200,
      width: 50,
      height: 50,
      hp: 10,
      color: "purple",
      speed: 1,
      canShoot: true,
    };

    const keys = {};
    window.addEventListener("keydown", (e) => {
      keys[e.key] = true;
      // Start game on SPACE at title screen
      if (e.key === " " && gameState === "start") {
        gameState = "world";
        enterCountry(0);
      }
      // When talking, press ENTER to close dialog
      if (e.key === "Enter" && dialogActive) {
        dialogBox.style.display = "none";
        dialogActive = false;
        gameState = "world";
      }
      // In combat or bossFight, allow shooting gun if owned via "s"
      if (
        e.key.toLowerCase() === "s" &&
        (gameState === "combat" || gameState === "bossFight") &&
        player.hasGun
      ) {
        bullets.push({
          x: player.x + player.width,
          y: player.y + player.height / 2 - 5,
          width: 10,
          height: 5,
          speed: bulletSpeed,
          color: "black",
        });
      }
      // In world, if near an NPC and pressing E, interact
      if (e.key.toLowerCase() === "e" && gameState === "world") {
        activeNPCs.forEach((npc) => {
          if (checkCollision(player, npc)) {
            // Shop NPC interaction
            if (npc.type === "shop") {
              if (score >= npc.cost && !player.hasGun) {
                score -= npc.cost;
                player.hasGun = true;
                currentDialog =
                  "You bought a gun! Use it with 'S' in combat.";
              } else if (player.hasGun) {
                currentDialog = "You already own a gun.";
              } else {
                currentDialog = "You don't have enough coins for a gun.";
              }
            } else {
              currentDialog = npc.dialog;
            }
            showDialog(currentDialog);
          }
        });
      }
    });
    window.addEventListener("keyup", (e) => {
      keys[e.key] = false;
    });

    document
      .getElementById("restartBtn")
      .addEventListener("click", restartGame);

    function showDialog(text) {
      dialogBox.innerText = text;
      dialogBox.style.display = "block";
      dialogActive = true;
      gameState = "talk";
    }

    function checkCollision(a, b) {
      return (
        a.x < b.x + b.width &&
        a.x + a.width > b.x &&
        a.y < b.y + b.height &&
        a.y + a.height > b.y
      );
    }

    // When entering a new country
    function enterCountry(index) {
      currentCountry = index;
      countryNameDisplayTime = COUNTRY_NAME_DISPLAY_DURATION;
      // Set active NPCs from country data AND add width/height for collision
      activeNPCs = countries[currentCountry].npcs.map((npcData) => ({
        ...npcData, // Copy existing properties (x, y, type, dialog, cost)
        width: 40,  // Add width for collision and drawing
        height: 40, // Add height for collision and drawing
      }));
      // Clear goons and coins to simulate fresh environment
      goons.length = 0;
      coins.length = 0; // Also clear coins when changing country
      coinTimer = 0;
      // Reset player position to start of the new country (optional, but good practice)
      player.x = 100;
      player.y = 300;
      // Ensure camera resets too
      camera.x = player.x - canvas.width / 2 + player.width / 2;
      camera.y = player.y - canvas.height / 2 + player.height / 2;
      camera.x = Math.max(
        worldBounds.x,
        Math.min(camera.x, worldBounds.width - canvas.width)
      );
      camera.y = Math.max(
        worldBounds.y,
        Math.min(camera.y, worldBounds.height - canvas.height)
      );
    }

    // Update function
    function update(deltaTime) {
      if (gameState === "world" || gameState === "combat") {
        // Player movement (free roam within world)
        if (keys["ArrowUp"] && player.y > worldBounds.y)
          player.y -= player.speed;
        if (
          keys["ArrowDown"] &&
          player.y + player.height < worldBounds.y + worldBounds.height
        )
          player.y += player.speed;
        if (keys["ArrowLeft"] && player.x > worldBounds.x)
          player.x -= player.speed;
        if (
          keys["ArrowRight"] &&
          player.x + player.width < worldBounds.x + worldBounds.width
        )
          player.x += player.speed;
        // Update camera to follow player (centered on canvas)
        camera.x = player.x - canvas.width / 2 + player.width / 2;
        camera.y = player.y - canvas.height / 2 + player.height / 2;
        // Clamp camera to world boundaries
        camera.x = Math.max(
          worldBounds.x,
          Math.min(camera.x, worldBounds.width - canvas.width)
        );
        camera.y = Math.max(
          worldBounds.y,
          Math.min(camera.y, worldBounds.height - canvas.height)
        );

        // Spawn goon obstacles with interval modified by current country's density
        goonTimer += deltaTime;
        if (
          goonTimer >
          baseGoonInterval / countries[currentCountry].goonDensity
        ) {
          const size = Math.random() * 30 + 20;
          goons.push({
            x: worldBounds.x + worldBounds.width,
            y: Math.random() * (worldBounds.height - size),
            width: size,
            height: size,
            speed: 0.5 + Math.random(), // slower goons
            color: "black",
          });
          goonTimer = 0;
        }
        // Update goons (move left slowly)
        for (let i = goons.length - 1; i >= 0; i--) {
          goons[i].x -= goons[i].speed;
          if (goons[i].x + goons[i].width < worldBounds.x) goons.splice(i, 1);
          // Collision with player triggers combat state
          if (checkCollision(player, goons[i])) {
            gameState = "combat";
          }
        }
        // Example: If player reaches right edge of world, advance to next country (or boss)
        if (player.x + player.width >= worldBounds.x + worldBounds.width) {
          if (currentCountry < countries.length - 1) {
            // Move to next country
            player.x = worldBounds.x + 10;
            enterCountry(currentCountry + 1);
          } else {
            // After last country, enter boss fight
            gameState = "bossFight";
          }
        }

        // (Optional) You can spawn coins randomly in world too for extra currency
        coinTimer += deltaTime;
        if (coinTimer > 3000) {
          // Create a coin at a random position in the world
          coins.push({
            x: worldBounds.x + Math.random() * worldBounds.width,
            y: worldBounds.y + Math.random() * worldBounds.height,
            width: 20,
            height: 20,
            speed: 0, // coins are static
            color: "gold",
          });
          coinTimer = 0;
        }
        // Check coin collection
        for (let i = coins.length - 1; i >= 0; i--) {
          if (checkCollision(player, coins[i])) {
            score += 1;
            coins.splice(i, 1);
          }
        }
      } else if (gameState === "bossFight") {
        // Boss can now fight back!
        boss.y += Math.sin(Date.now() / 500) * boss.speed;
        // Boss shoots bullets periodically
        if (Math.random() < 0.02) {
          bullets.push({
            x: boss.x,
            y: boss.y + boss.height / 2 - 5,
            width: 10,
            height: 5,
            speed: -bulletSpeed,
            color: "red",
          });
        }
        // Update boss bullets
        for (let i = bullets.length - 1; i >= 0; i--) {
          bullets[i].x += bullets[i].speed;
          if (bullets[i].x + bullets[i].width < worldBounds.x)
            bullets.splice(i, 1);
          else if (checkCollision(bullets[i], player)) {
            gameState = "over";
          }
        }
        // Player opponent actions remain similar
        if (keys["ArrowUp"] && player.y > worldBounds.y)
          player.y -= player.speed;
        if (
          keys["ArrowDown"] &&
          player.y + player.height < worldBounds.y + worldBounds.height
        )
          player.y += player.speed;
        if (keys["ArrowLeft"] && player.x > worldBounds.x)
          player.x -= player.speed;
        if (
          keys["ArrowRight"] &&
          player.x + player.width < worldBounds.x + worldBounds.width
        )
          player.x += player.speed;
        // Update camera in bossFight (similar to world)
        camera.x = player.x - canvas.width / 2 + player.width / 2;
        camera.y = player.y - canvas.height / 2 + player.height / 2;
        camera.x = Math.max(
          worldBounds.x,
          Math.min(camera.x, worldBounds.width - canvas.width)
        );
        camera.y = Math.max(
          worldBounds.y,
          Math.min(camera.y, worldBounds.height - canvas.height)
        );
        // Update player shooting (gun) handled by key event "s"
        // Bullets from player are already moving rightwards in event handler
        for (let i = bullets.length - 1; i >= 0; i--) {
          // Check player bullets collision with boss
          if (checkCollision(bullets[i], boss)) {
            boss.hp--;
            bullets.splice(i, 1);
            if (boss.hp <= 0) {
              gameState = "win";
            }
          }
        }
        // Collision between boss and player
        if (checkCollision(player, boss)) {
          gameState = "over";
        }
      }
      // Country name animation timer
      if (countryNameDisplayTime > 0) countryNameDisplayTime -= deltaTime;
    }

    function draw() {
      // Clear the entire visible canvas *before* any camera transforms
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      // --- World Drawing (with camera) ---
      ctx.save(); // Save context state before applying camera
      ctx.translate(-camera.x, -camera.y); // Apply camera offset

      // Draw background (simple ground)
      ctx.fillStyle = "#7CFC00";
      ctx.fillRect(
        worldBounds.x,
        worldBounds.y + worldBounds.height - 100,
        worldBounds.width,
        100
      );

      // Draw coins in world
      coins.forEach((c) => {
        ctx.fillStyle = c.color;
        ctx.fillRect(c.x, c.y, c.width, c.height);
      });

      // Draw goons
      goons.forEach((g) => {
        ctx.fillStyle = g.color;
        ctx.fillRect(g.x, g.y, g.width, g.height);
        // Draw label centered in goon
        ctx.save(); // Save state before changing text properties
        ctx.fillStyle = "white";
        ctx.font = "12px monospace";
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        ctx.fillText("goon", g.x + g.width / 2, g.y + g.height / 2);
        ctx.restore(); // Restore text properties
      });

      // Draw NPC shacks (as simple rectangles)
      activeNPCs.forEach((npc) => {
        ctx.fillStyle = npc.type === "shop" ? "#555" : "#333";
        // Use npc width/height for drawing
        ctx.fillRect(npc.x, npc.y, npc.width, npc.height);
        ctx.save();
        ctx.fillStyle = "#fff";
        ctx.font = "10px sans-serif";
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        // Center text within the npc bounds
        ctx.fillText(npc.type, npc.x + npc.width / 2, npc.y + npc.height / 2);
        ctx.restore();
      });

      // Draw player
      ctx.fillStyle = player.color;
      ctx.fillRect(player.x, player.y, player.width, player.height);

      // Draw boss and its bullets in bossFight
      if (gameState === "bossFight") {
        ctx.fillStyle = boss.color;
        ctx.fillRect(boss.x, boss.y, boss.width, boss.height);
        // Boss health bar
        ctx.fillStyle = "red";
        ctx.fillRect(boss.x, boss.y - 20, boss.hp * 20, 10); // Assuming max HP relates to this width
        bullets.forEach((b) => {
          ctx.fillStyle = b.color; // Ensure bullet color is set before drawing
          ctx.fillRect(b.x, b.y, b.width, b.height);
        });
      }

      ctx.restore(); // Restore context state after camera transform

      // --- Overlay UI Drawing (drawn directly on canvas, ignoring camera) ---
      ctx.fillStyle = "black";
      ctx.font = "20px sans-serif";
      ctx.fillText(`Coins: ${score}`, 10, 25);
      ctx.fillText(
        `Weapon: ${player.hasGun ? "Gun & Sword" : "Sword"}`,
        10,
        50
      );
      // Position country name relative to canvas width
      ctx.textAlign = "right"; // Align text to the right
      ctx.fillText(`Country: ${countries[currentCountry].name}`, canvas.width - 10, 25);
      ctx.textAlign = "left"; // Reset alignment for other text

      if (gameState === "bossFight") {
        ctx.textAlign = "center";
        ctx.fillText("Boss Fight!", canvas.width / 2, 25);
        ctx.textAlign = "left"; // Reset alignment
      }

      // Display country name animation
      if (countryNameDisplayTime > 0) {
        ctx.fillStyle =
          "rgba(0,0,0," +
          countryNameDisplayTime / COUNTRY_NAME_DISPLAY_DURATION +
          ")";
        ctx.font = "40px serif";
        ctx.textAlign = "center";
        ctx.fillText(countries[currentCountry].name, canvas.width / 2, 150);
        ctx.textAlign = "left"; // Reset alignment
      }

      // Title screen
      if (gameState === "start") {
        ctx.fillStyle = "rgba(0, 0, 0, 0.7)"; // Semi-transparent background
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = "white";
        ctx.font = "30px monospace";
        ctx.textAlign = "center";
        ctx.fillText("GOONERBAIT 3D Adventure", canvas.width / 2, 250);
        ctx.font = "20px sans-serif";
        ctx.fillText("Press SPACE to start your journey", canvas.width / 2, 300);
        ctx.textAlign = "left"; // Reset alignment
      }

      // Win and Game Over screens (ensure restart button is visible)
      if (gameState === "win" || gameState === "over") {
        ctx.fillStyle = "rgba(0, 0, 0, 0.7)";
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = "white";
        ctx.font = "40px monospace";
        ctx.textAlign = "center";
        if (gameState === "win") {
          ctx.fillText("YOU DEFEATED THE BOSS!", canvas.width / 2, 300);
        } else {
          ctx.fillText("GAME OVER", canvas.width / 2, 300);
        }
        document.getElementById("restartBtn").style.display = "block"; // Show restart button
        ctx.textAlign = "left"; // Reset alignment
      } else {
        document.getElementById("restartBtn").style.display = "none"; // Hide restart button otherwise
      }
    }

    let lastTime;
    function gameLoop(timestamp) {
      if (!lastTime) lastTime = timestamp;
      const deltaTime = timestamp - lastTime;
      lastTime = timestamp;

      update(deltaTime);
      draw();
      requestAnimationFrame(gameLoop);
    }

    function restartGame() {
      gameState = "start";
      score = 0;
      currentCountry = 0;
      player.x = 100;
      player.y = 300;
      player.hasGun = false;
      goons.length = 0;
      coins.length = 0;
      bullets.length = 0;
      activeNPCs = [];
      countryNameDisplayTime = 0;
      boss.hp = 10; // Reset boss health
      document.getElementById("restartBtn").style.display = "none";
    }

    requestAnimationFrame(gameLoop);
  </script>
</body>

</html>